

## Требования к окружению и установка:
Для работы потребуется менеджер зависмостей `uv`. Установить его по инструкции из GitHub репозитория astral-sh/uv:
https://github.com/astral-sh/uv?tab=readme-ov-file#installation

Установка зависимостей происходит через Make команду:
```bash
make sync
```

## Запуск тестов
Для запуска тестов можно воспользоваться Make командой:
```bash
make test
```

## Запуск сервера
Поднять сервер с API можно через команду Make:
```bash
make run/api
```


## Требования к окружению и установка
1. **Язык**: Python 3.9+.
2. **Основные библиотеки**: FastAPI, Uvicorn, Pydantic, Pytest.
3. **Менеджер зависимостей**: uv, установка требуемых зависимостей описана выше

## Конфигурация
Создайте файл `config.json`
Файл настроек должен располагаться в корневой директории. 

### NOTE: Права доступа к файлу должны быть `600` (чтение только владельцем) для защиты секрета

пример `config.json` так же он есть в файле `example.config.json`

```json
{
  "hmac_alg": "SHA256" (поддерживается только этот алгоритм),
  "secret": "<base64_encoded_secret>" (секрет должен быть в виде b64 строки),
  "log_level": "info" (уровень логгирования),
  "listen": "0.0.0.0:8080" (хост и порт приложения),
  "max_msg_size_bytes": 1048576 (максимальный размер сообщения)
}
```

## Генерация и ротация секрета

Для генерации нового криптографически стойкого ключа и его автоматического обновления в конфиге реализована утилита ротации:

Из корневой директории запустить скрипт при созданном `config.py`

```bash
python /src/services/utils/rotate_secret.py
```
После выполнения команды сервер необходимо перезапустить для применения нового ключа

### NOTE: Автоматическая генерация секрета с правами `600` доступна только на unix-подобных системах

## Примеры использования (CURL)

Все эндпоинты принимают и возвращают данные в формате `JSON`

Подписать сообщение `/sign`

```bash
curl -sS -X POST http://localhost:8080/api/v1/hmac_sign/sign \
  -H 'Content-Type: application/json' \
  -d '{"msg":"hello"}'
```
Возвращает подпись в формате `base64url` без паддинга

Проверить подпись `/verify`

```bash
curl -sS -X POST http://localhost:8080/api/v1/hmac_sign/verify \
  -H 'Content-Type: application/json' \
  -d '{"msg":"hello", "signature":"<скопировать из /sign>"}'
```

Возвращает `{"ok": true}` при совпадении и `{"ok": false}` при несовпадении подписи

## Ограничения учебной реализации

1. **Симметричный алгоритм:** Отправитель и проверяющий используют один общий секрет. В отличие от асимметричной ЭП, здесь нет разделения на приватный и публичный ключи
2. **Отсутствие неотказуемости:** HMAC не позволяет доказать третьей стороне, кто именно из владельцев ключа создал подпись.
3. **Нет шифрования:** Механизм обеспечивает только целостность и аутентичность, но не скрывает содержимое сообщения от перехвата.
4. **Упрощенная ротация:** Ротация ключа требует перезаписи файла конфигурации и перезапуска сервиса.

## Покрытие тестами

1. Основные сценарии использвания ручек `/sign` и `/verify` - включая ошибочные запросы, неверные подписи, пустые сообщения, а также подмену сообщения/подписи
2. Нагрузочное тестирование в `100 RPS`
3. Тестирование функций кодирования и декодирования `base64url` с отбрасыванием паддинга
4. Тестирование валидности конфигурации
5. Тестирование функций сервиса `hmac_service.py`

#### NOTE более подробно с тесами (кодом) можно познакомиться в дирректории `/tests`
